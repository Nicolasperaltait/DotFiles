let aBrowser=this.isChrome()?chrome:Object.assign(browser,{action:browser.browserAction,scripting:{executeScript:({target:e,files:t,func:r,args:a},s)=>{r||browser.tabs.executeScript(e.tabId,{file:t[0]},s)},insertCSS:({target:e,files:t})=>{browser.tabs.insertCSS(e.tabId,{file:t[0]})}}});const iconPathEnded="../assets/images/logo-16-gray.png",iconPathStarted="../assets/images/logo-16.png",clockifyProd="https://app.clockify.me/tracker";let windowIds=[];const commands={startStop:"quick-start-stop-entry"};async function tryCommunicateWithContentScript(e){try{const{sendMessage:t}=aBrowser.tabs;return await t(e,{eventName:"integrationInjected"}),!0}catch{return!1}}function setTimeEntryInProgress(e){e?.timeInterval&&null!==e.timeInterval.end||aBrowser.storage.local.set({timeEntryInProgress:e})}function setClockifyOriginsToStorage(){fetch("integrations/integrations.json").then((e=>e.json())).then((async e=>{const t=await localStorage.getItem("userId");t&&aBrowser.storage.local.get("permissions",(r=>{const a=r.permissions?r.permissions:[];let s;if(0===a.filter((e=>e.userId===t)).length){s={userId:t,permissions:[]},a.push(s);for(let t in e)s.permissions.push({domain:t,urlPattern:e[t].link,isEnabled:!0,script:e[t].script,name:e[t].name,isCustom:!1});aBrowser.storage.local.set({permissions:a})}}))}))}function loadScripts(e,t){try{aBrowser.scripting.executeScript({target:{tabId:e},files:["integrations/"+t.file]})}catch(e){}}async function extractDomainInfo(e,t){let{hostname:r}=parseURLString(e),{file:a,integrationName:s}=await getOriginFileName(e,t);return{domain:e,hostname:r,integrationName:s,file:a,origins:["*://"+r+"/*"]}}async function extractAndSaveToken(e){const[t,r]=e.split("?")[1].replace("accessToken=","").replace("refreshToken=","").split("&");await localStorage.setItem("token",t),await localStorage.setItem("refreshToken",r),await UserService.getAndStoreUser(),setClockifyOriginsToStorage();const a=await localStorage.getItem("lang");clockifyLocales.onProfileLangChange(a);const s=await TokenService.isLoggedIn(),n=await TimeEntry.getEntryInProgress();s&&n.entry&&aBrowser.action.setIcon({path:iconPathStarted}),TimeEntry.getTimeEntries(1,50).then((async e=>{e&&e.data&&await localStorage.setItem("preData",{bgEntries:e.data.timeEntriesList,durationMap:e.data.durationMap,weekStatusMap:e.data.weekStatusMap})})),ProjectTaskService.getProjectsWithFilter("",1,50).then((e=>{e&&e.data&&localStorage.setItem("preProjectList",{projectList:e.data})})),TagService.getAllTagsWithFilter(1,50).then((e=>{e&&e.data&&e.data.length&&localStorage.setItem("preTagsList",e.data)}))}async function checkState(e){const t=await localStorage.getItem("selfhosted_oAuthState");return!(e&&t&&t===atob(e))}function getParamFromUrl(e,t){let r="";return e&&(r=e.split("&").filter((e=>e.includes(t))).map((e=>e.split("=")[1]))[0]),r}async function getOriginFileName(e,t){const r=await localStorage.getItem("userId");if(!t)return null;const a=t.filter((e=>e.userId===r))[0];if(!a)return null;let s=a.permissions.filter((e=>e.isEnabled)).find((t=>isMatchingURL(t.urlPattern,e)));return{file:s?.script,integrationName:s?.name}}async function rerenderIntegrations(){const e=(await aBrowser.tabs.query({})).map((({id:e})=>e));for(const t of e)aBrowser.tabs.sendMessage(t,{eventName:"rerenderIntegrations"})}function afterStartTimer(){addIdleListenerIfIdleIsEnabled(),removeReminderTimer()}Object.freeze(commands),aBrowser.tabs.onUpdated.addListener((async(e,t,r)=>{if(r.url.includes(aBrowser.identity.getRedirectURL()))try{await this.extractAndSaveToken(r.url)}catch(e){console.log(e)}finally{const t=await localStorage.getItem("signupExpected"),r=await localStorage.getItem("permanent_homeUrl")||"https://app.clockify.me/tracker";JSON.parse(t)?aBrowser.tabs.update(e,{url:r}):aBrowser.tabs.remove(e,(()=>{})),await localStorage.setItem("signupExpected","false")}else"complete"===t.status&&aBrowser.storage.local.get("permissions",(async t=>{const a=await TokenService.isLoggedIn();if(!r.url.includes("chrome://")&&a){const a=await localStorage.getItem("lang");await clockifyLocales.onProfileLangChange(a);let s=await extractDomainInfo(r.url,t.permissions);if(s.file){if(await tryCommunicateWithContentScript(e))return;aBrowser.tabs.sendMessage(e,{eventName:"cleanup"}),aBrowser.scripting.executeScript({target:{tabId:e},files:["popupDlg/clockifyDebounce.js"]}),aBrowser.scripting.executeScript({target:{tabId:e},files:["contentScripts/clockifyLocales.js"]},(()=>{aBrowser.scripting.executeScript({target:{tabId:e},files:["popupDlg/clockifyButton.js"]},(async()=>{IntegrationSelectors.fetchAndStore({onlyIfPassedFollowingMinutesSinceLastFetch:720}),await aBrowser.tabs.sendMessage(e,{eventName:"passArgumentsToClockifyButton",options:{integrationName:s.integrationName}}),loadScripts(e,s),setTimeout((()=>{backgroundWebSocketConnect()}),1e3)}))}))}}}))})),aBrowser.runtime.onInstalled.addListener((async e=>{"install"===e.reason&&(aBrowser.tabs.create({url:clockifyProd}),aBrowser.action.setIcon({path:iconPathEnded}));const t=await localStorage.getItem("locale_messages");t&&!Object.keys(t).length||clockifyLocales.onProfileLangChange(null),IntegrationSelectors.fetchAndStore({onlyIfPassedFollowingMinutesSinceLastFetch:1})})),_messageExternal_busy=!1,aBrowser.windows.getAll({populate:!0,windowTypes:["normal"]},(e=>{for(windowInfo of e)windowIds.push(windowInfo.id)})),aBrowser.runtime.onStartup.addListener((async()=>{if(IntegrationSelectors.fetchAndStore({onlyIfPassedFollowingMinutesSinceLastFetch:1}),await TokenService.isLoggedIn()){const{entry:e,error:t}=await TimeEntry.getEntryInProgress();null===e||t?(this.addReminderTimerOnStartingBrowser(),aBrowser.runtime.sendMessage({eventName:"createStopTimerEvent"}),TimeEntry.startTimerOnStartingBrowser(),setTimeEntryInProgress(null),aBrowser.action.setIcon({path:iconPathEnded})):(setTimeEntryInProgress(e),aBrowser.action.setIcon({path:iconPathStarted})),this.connectWebSocket()}})),aBrowser.windows.onCreated.addListener((async e=>{if(await TokenService.isLoggedIn()&&0===windowIds.length){const{entry:e,error:t}=await TimeEntry.getEntryInProgress();null===e||t?(this.addReminderTimerOnStartingBrowser(),TimeEntry.startTimerOnStartingBrowser(),setTimeEntryInProgress(null),aBrowser.action.setIcon({path:iconPathEnded})):(setTimeEntryInProgress(e),aBrowser.action.setIcon({path:iconPathStarted})),this.connectWebSocket()}windowIds=[...windowIds,e.id]})),aBrowser.windows.onRemoved.addListener((e=>{windowIds.includes(e)&&windowIds.splice(windowIds.indexOf(e),1),0===windowIds.length&&(this.removeReminderTimer(),TimeEntry.endInProgressOnClosingBrowser(),this.disconnectWebSocket(),this.restartPomodoro())})),setClockifyOriginsToStorage(),UserWorkspaceStorage.getSetWorkspaceSettings(),UserWorkspaceStorage.getWasRegionalEverAllowed(),UserWorkspaceStorage.getPermissionsForUser().then((e=>{if(e.data){const t=e.data.filter((e=>"WORKSPACE_OWN"===e.name||"WORKSPACE_ADMIN"===e.name)).length>0;localStorage.setItem("isUserOwnerOrAdmin",t)}})),UserService.getSetUserRoles(),setTimeout((()=>{backgroundWebSocketConnect()}),1e3),aBrowser.commands.onCommand.addListener((async e=>{const t=await localStorage.getItem("permanent_timerShortcut"),r=await localStorage.getItem("userId"),a=t&&JSON.parse(t).find((e=>e?.userId===r&&JSON.parse(e.enabled))),s=await TokenService.isLoggedIn();if(!a)return;if(e!==commands.startStop)return;if(!s)return void localStorage.setItem("integrationAlert","You must log in to use keyboard shortcut (backgorund)");const{entry:n,error:o}=await TimeEntry.getEntryInProgress();if(n){const{error:e}=await TimeEntry.endInProgress({timeEntry:n})}else TimeEntry.startTimer("")})),self.addEventListener("online",(()=>{localStorage.setItem("offline","false"),aBrowser.runtime.sendMessage({eventName:"STATUS_CHANGED_ONLINE"})})),self.addEventListener("offline",(()=>{localStorage.setItem("offline","true"),aBrowser.runtime.sendMessage({eventName:"STATUS_CHANGED_OFFLINE"})})),self.ononline=e=>{localStorage.setItem("offline","false"),aBrowser.runtime.sendMessage({eventName:"STATUS_CHANGED_ONLINE"})},self.onoffline=e=>{localStorage.setItem("offline","true"),aBrowser.runtime.sendMessage({eventName:"STATUS_CHANGED_OFFLINE"})},aBrowser.runtime.onMessage.addListener(((e,t,r)=>{switch(e.eventName){case"rerenderIntegrations":return rerenderIntegrations();case"refreshIntegrationsClicked":return IntegrationSelectors.fetchAndStore({onlyIfPassedFollowingMinutesSinceLastFetch:1});case"takeTimeEntryInProgress":case"fetchEntryInProgress":case"getDefaultProjectTask":case"getRecentTimeEntries":case"getUser":case"getUserRoles":case"getBoot":case"getPermissionsForUser":case"getNotificationsForUser":case"getNewsForUser":case"getVerificationNotificationsForUser":case"getWorkspaceSettings":case"getWorkspacesOfUser":case"getWasRegionalEverAllowed":case"invalidateToken":case"checkInternetConnection":case"resendVerificationEmail":case"sendEmailVerification":case"updateNewsSubscription":return ClockifyIntegration.callFunction(e.eventName,null,r);case"endInProgress":case"getMemberProfile":case"getProjectsByIds":case"startWithDescription":case"getTimeEntries":case"changeStart":case"editTimeInterval":case"getEntryInProgress":case"setDescription":case"removeProject":case"getProjects":case"readSingleOrMultipleNewsForUser":case"readSingleNotificationForUser":case"readSingleOrMultipleVerificationNotificationForUser":case"readManyNotificationsForUser":case"changeTimezone":case"removeDeclinedUserFromWorkspace":case"changeWorkspaceStatus":case"setDefaultUserWorkspace":case"getLastUsedProjectFromTimeEntries":case"getProjectTasks":case"getTaskOfProject":case"submitDescription":case"createProject":case"editProject":case"createTask":case"editTask":case"getTags":case"createTag":case"editTags":case"deleteTimeEntry":case"continueEntry":case"searchEntries":case"duplicateTimeEntry":case"updateTimeEntryValues":case"deleteTimeEntries":case"removeProjectAsFavorite":case"makeProjectFavorite":case"editBillable":case"submitTime":case"getWSCustomField":case"submitCustomField":case"generateManualEntryData":case"removeTask":case"setDefaultWorkspace":case"signup":case"getClientsWithFilter":case"createClient":case"sendAnalyticsEvent":return ClockifyIntegration.callFunction(e.eventName,e,r);default:return!1}})),(async()=>{if(await TokenService.isLoggedIn()){const{entry:e,error:t}=await TimeEntry.getEntryInProgress();null===e||t?(TimeEntry.startTimerOnStartingBrowser(),setTimeEntryInProgress(null),aBrowser.action.setIcon({path:iconPathEnded})):(setTimeEntryInProgress(e),aBrowser.action.setIcon({path:iconPathStarted}))}else aBrowser.action.setIcon({path:iconPathEnded})})();