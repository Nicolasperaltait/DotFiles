var _clockifyPopupDlg,aBrowser=chrome||browser,_waitingForResponse=!1,_selectors=null,_clockifyShowPostStartPopup=!0,documents=window.getAllDocuments();removeAllButtons(),setPostStartPopup(),_clockifyShowPostStartPopup=!0,aBrowser.storage.local.get(["permanent_showPostStartPopup"]).then((t=>{t.permanent_showPostStartPopup?_clockifyShowPostStartPopup=JSON.parse(t.permanent_showPostStartPopup):aBrowser.storage.local.set({permanent_showPostStartPopup:"true"})}));var clockifyButton={inProgressDescription:"",nextIndex:0,mutationObserver:{observer:null,allSelectors:[],callback:t=>{for(const e of clockifyButton.mutationObserver.allSelectors){const{selector:o,renderer:n,mutationSelector:i}=e;i&&!t.filter((t=>t.target.matches(i))).length||clockifyButton.renderTo(o,n)}},start:(t,e,o,n)=>{const{mutationObserver:i}=clockifyButton;e.observe&&(i.observer||(e.noDebounce?i.observer=new MutationObserver(i.callback):i.observer=new MutationObserver(clockifyDebounce(i.callback,1e3)),documents.forEach((t=>{i.observer.observe(t,{childList:!0,subtree:!0})}))),i.allSelectors.push({selector:t,renderer:o,mutationSelector:n}))}},observeDescription:t=>{t&&setInterval((()=>{const e=document.querySelector(t),o=closestClockifyButton(e);e&&o&&o.setAttribute("title",e.textContent)}),500)},render:(t,e,o,n,i)=>{clockifyButton.mutationObserver.start(t,e,o,n),clockifyButton.observeDescription(i),clockifyButton.renderTo(t,o)},rerenderAllButtons:()=>{Array.from($$$(".clockifyButton, #clockify-manual-input-form, .clockify-widget-container, .button-link:has(.clockifyButton)")).forEach((t=>t?.remove())),$$$(".clockify").forEach((t=>t.classList.remove("clockify")))},renderTo:(t,e)=>{$$$(t).forEach(((t,o)=>{t.classList.add("clockify","clockify"+o),e(t,t.ownerDocument)}))},createButton:(t,e,o)=>{const n=clockifyButton.nextIndex++;window.updateButtonProperties({newRoot:!0,buttonId:n},{isPopupOpen:!1});const i=objectFromParams(t,e,o);clockifyButton.options=i;const r=document.createElement("div");invokeIfFunction(i.small)&&r.classList.add("small");let s=invokeIfFunction(i.description);return aBrowser.storage.local.get(["timeEntryInProgress","permanent_appendWebsiteURL","userId"],(t=>{let e=" | ";if(t.permanent_appendWebsiteURL){s.includes(" | ")&&(e=" || ");const t=`${document.title} - ${window.location.href}`;s.includes(t)||(s+=`${e}${t}`)}t.userId&&(clockifyButton.userId=t.userId);const o=t.timeEntryInProgress;o&&o.id?o.description?clockifyButton.inProgressDescription=o.description:clockifyButton.inProgressDescription="":clockifyButton.inProgressDescription=null;const c=s&&removeAppendedURL(s,e)===removeAppendedURL(clockifyButton.inProgressDescription,e);setButtonProperties(r,s,c,n),this.setClockifyButtonLinks(r),window.updateButtonProperties({options:i,title:s,active:c,small:!!i.small,buttonId:n,integrationName:clockifyButton?.injectedArguments?.integrationName},{inProgressDescription:clockifyButton.inProgressDescription})})),r},createSmallButton:(t,e)=>{const o=objectFromParams(t,e);return o.small=!0,clockifyButton.createButton(o)},createInput:t=>{const e=document.createElement("form"),o=document.createElement("input");e.setAttribute("id","clockify-manual-input-form"),e.appendChild(o),o.classList.add("clockify-input","clockify-input-default"),o.setAttribute("placeholder",clockifyLocales.ADD_TIME_MANUAL);let n=!1;return o.addEventListener("focus",(()=>{window.updateButtonProperties(null,{timeEntry:{originalInput:o.value},isPopupOpen:!1,manualMode:!0,inputElement:o})}),{once:!0}),aBrowser.storage.local.get(["workspaceSettings"],(t=>{if("STOPWATCH_ONLY"===(t=JSON.parse(t.workspaceSettings)).timeTrackingMode){e.style.display="none";const t=$(".input-button-link");t&&(t.style.display="none")}else{e.style.display="inline-block";const t=$(".input-button-link");t&&(t.style.display="inline-block")}})),aBrowser.storage.local.get(["wsCustomFields"],(t=>{t.wsCustomFields&&JSON.parse(t.wsCustomFields).forEach((t=>{t.required&&(n=!0)}))})),e.onsubmit=async e=>{if(e.preventDefault(),e.stopPropagation(),console.log("SUBMITTED"),"Forbidden"===await aBrowser.runtime.sendMessage({eventName:"getEntryInProgress"}))return void alert(clockifyLocales.WORKSPACE_LOCKED);let i=await localStorage.getItem("workspaceSettings");if(i=JSON.parse(i),i.features&&"SELF_HOSTED"!==i.features.featureSubscriptionType&&!i.features.timeTracking){const t=await localStorage.getItem("isUserOwnerOrAdmin"),e=await localStorage.getItem("wasRegionalEverAllowed");return void alert(e?t?clockifyLocales.SUBSCRIPTION_EXPIRED:clockifyLocales.FEATURE_DISABLED_CONTACT_ADMIN:t?clockifyLocales.UPGRADE_REGIONAL_ADMIN:clockifyLocales.UPGRADE_REGIONAL)}const r=objInvokeIfFunction(t),s=await localStorage.getItem("permanent_appendWebsiteURL");let c=r.description;if(s){const t=c.includes(" | ")?" || ":" | ",e=`${document.title} - ${window.location.href}`;c.includes(e)||(c+=`${t}${e}`),r.description=c}try{const t=o.value,e=t.match(/(?=.{2,})^(\d+d)?\s*(\d+h)?\s*(\d+m)?$/);if(e){o.value=clockifyLocales.SUBMITTING;const i=480*parseInt(e[1]||0,10)+60*parseInt(e[2]||0,10)+parseInt(e[3]||0,10);aBrowser.storage.local.get(["wsSettings"],(async e=>{const{wsSettings:s}=e;if(s.forceDescription&&!c||s.forceProjects||s.forceTasks||s.forceTags||n||_clockifyShowPostStartPopup)if(r.projectName||r.tagNames){const e=await aBrowser.runtime.sendMessage({eventName:"generateManualEntryData",options:r}),n={...r,totalMins:i,originalInput:t,projectId:!e.task?.id&&s.forceTasks?null:e.project?.id,taskId:e.task?.id,billable:e.project?.billable,tags:e.tags,tagIds:e.tags?.map((t=>t.id))??[],project:e.project,task:e.task};window.updateButtonProperties(null,{timeEntry:n,manualMode:!0,isPopupOpen:!0,inputElement:o,integrationName:clockifyButton?.injectedArguments?.integrationName}),o.value=""}else{const e=await aBrowser.runtime.sendMessage({eventName:"getDefaultProjectTask"}),n={...r,totalMins:i,originalInput:t,projectId:e.projectDB?.id,taskId:e.taskDB?.id,billable:e.projectDB?.billable,project:e.projectDB,task:e.taskDB};window.updateButtonProperties(null,{timeEntry:n,manualMode:!0,isPopupOpen:!0,inputElement:o,integrationName:clockifyButton?.injectedArguments?.integrationName}),o.value=""}else inputMessage(o,clockifyLocales.SUBMITTING),aBrowser.runtime.sendMessage({eventName:"submitTime",options:{totalMins:i,timeEntryOptions:r,integrationName:clockifyButton?.injectedArguments?.integrationName}},(t=>{o.value="",t?"string"==typeof t?alert(t):201!==t.status?400===t.status&&(t.endInProgressStatus?(inputMessage(o,"Error: "+t.status,"error"),alert(`${clockifyLocales.YOU_ALREADY_HAVE_ENTRY_WITHOUT}.\n${clockifyLocales.PLEASE_EDIT_YOUR_TIME_ENTRY}.`)):alert(clockifyLocales.CANNOT_START_ENTRY_WITHOUT_PROJECT)):inputMessage(o,clockifyLocales.TIME_ADDED,"success"):inputMessage(o,"Error: "+(t??""),"error")}))}))}else inputMessage(o,"Format: 1d 2h 30m","error",!0)}catch(e){console.error(e)}return!1},e},observeDarkMode:t=>{function e(){return t()?function(){if($(".clockify-custom-style-dark"))return;const t=createTag("style","clockify-custom-style-dark","\n\t\t\t\t.clockify-input {\n\t\t\t\t\tbackground: #333 !important;\n\t\t\t\t\tborder: #444 !important;\n\t\t\t\t\tcolor: #f4f4f4 !important;\n\t\t\t\t}\n\t\n\t\t\t\t.clockify-button-inactive {\n\t\t\t\t\tcolor: rgba(255, 255, 255, 0.81) !important;\n\t\t\t\t}");document.head.append(t)}():void $(".clockify-custom-style-dark")?.remove()}new MutationObserver(e).observe(document.body,{attributes:!0}),e()}};function objectFromParams(t,e,o){return"object"==typeof t?t:{description:t||"",projectName:e||null,taskName:o||null,billable:null}}function $(t,e=document){return e.querySelector(t)}function $$(t,e=document){return e.querySelectorAll(t)}function $$$(t,e=documents){return e.map((e=>e.querySelectorAll(t))).map((t=>Array.from(t))).flat()}function text(t,e=document){return $(t,e)?.textContent?.trim()}function value(t,e=document){return $(t,e)?.value?.trim()}function textList(t,e=document,o=!0){const n=Array.from($$(t,e)||[]).map((t=>t.textContent)).filter((t=>Boolean(t))).map((t=>t.trim()));return o?[...new Set(n)]:n}function timeout({milliseconds:t}){return new Promise((e=>setTimeout(e,t)))}function waitForElement(t,e=document){return new Promise((o=>{if($(t,e))return o($(t,e));const n=new MutationObserver((function(){const i=$(t,e);i&&(n.disconnect(),o(i))})),i=document.body;n.observe(i,{childList:!0,subtree:!0})}))}function applyStyles(t,e="clockify-custom-styles"){removeStyles(e);const o=createTag("style",e,t);document.head.append(o)}function removeStyles(t="clockify-custom-styles"){const e=t.split(" ").map((t=>`.${t}`)).join("");$(e)?.remove()}async function getSelectors(t,e,o){if(!_selectors){const t=await aBrowser.storage.local.get(["integrationSelectors"]),{integrationSelectors:e}=t;_selectors=e}return o?_selectors[t][e][o]:e?_selectors[t][e]:t?_selectors[t]:_selectors}function invokeIfFunction(t){return t instanceof Function?invokeIfFunction(t()):t}function objInvokeIfFunction(t){const e={};for(const o of Object.keys(t))e[o]=invokeIfFunction(t[o]);return e}function createTag(t,e="",o=""){const n=document.createElement(t);return n.className=e,n.textContent=o,n}function removeAppendedURL(t,e){return t?.split(e)[0]}function closestClockifyButton(t,e=".clockifyButton"){let o=t;for(;o;){const t=o.querySelector(e);if(t)return t;o=o.parentElement}return null}function inputMessage(t,e,o,n=!1){t.readOnly=!0;const i=t.value,r=["clockify-input-default","clockify-input-error","clockify-input-success"];t.classList.remove(...r),t.classList.add("clockify-input-"+o),t.value=e,setTimeout((()=>{t.value=n?"":i,t.classList.remove(...r),t.classList.add("clockify-input-default"),t.readOnly=!1}),1500)}function setButtonProperties(t,e,o,n=0){t.title=e,t.classList.add("clockifyButton","clockifyButtonId"+n),t.classList.contains("small")?t.setAttribute("id","clockifySmallButton"):t.setAttribute("id","clockifyButton"),window.updateButtonProperties({title:e,active:o,small:t.classList.contains("small"),buttonId:n},{inProgressDescription:clockifyButton.inProgressDescription})}function updateButtonOnProgressChanged(t){const{newValue:e,oldValue:o}=t;clockifyButton.inProgressDescription=e&&e.id?e.description:"",$$$(".clockifyButton").forEach((t=>{const n=t.className.match(/clockifyButtonId(\d+)/)[1],i=t.title||t.dataset.title;let r=" | ";i?.includes(" | ")&&(r=" || ");const s=removeAppendedURL(i,r),c=removeAppendedURL(e?.description,r),l=removeAppendedURL(o?.description,r),a=e&&s===c;(s===c||s===l)&&(console.count("updateButtonState"),this.setButtonProperties(t,clockifyButton.inProgressDescription||i,a,n)),t.onEntryChanged&&t.onEntryChanged(e)}))}async function hideClockifyButtonLinks(){const t=document.createElement("style");t.innerText="\n\t\t#clockifyButton, #clockify-manual-input-form { \n\t\t\tdisplay: none !important; \n\t\t}\n\t",document.head.appendChild(t)}function setClockifyButtonLinks(t){document.clockifyButtonLinks=document.clockifyButtonLinks||[],document.clockifyButtonLinks.push(t)}function removeAllButtons(t){const e=$$$(t||".clockifyButton, #clockify-manual-input-form"),o=$$$(".clockify");e.forEach((t=>t.parentNode.removeChild(t))),o.forEach((t=>t.classList.remove("clockify")))}async function setPostStartPopup(){const{permanent_showPostStartPopup:t}=await aBrowser.storage.local.get(["permanent_showPostStartPopup"]);t?_clockifyShowPostStartPopup=JSON.parse(t):aBrowser.storage.local.set({permanent_showPostStartPopup:"true"})}function clockifyDestroyPopupDlg(){const t=document.getElementById("divClockifyPopupDlg");t&&window.clockifyListeners&&(window.removeEventListener("click",window.clockifyListeners.clockifyClicks,!0),window.removeEventListener("change",window.clockifyListeners.clockifyChanges,!0),window.removeEventListener("resize",window.clockifyListeners.clockifyTrackResize,!0),window.removeEventListener("scroll",window.clockifyListeners.clockifyTrackScroll,!0),_clockifyPopupDlg.destroy(),document.body.removeChild(t),document.removeEventListener("click",window.clockifyListeners.clockifyRemovePopupDlg,!0),_clockifyPopupDlg=null)}function clockifyRepositionDropDown(){document.getElementById("divClockifyProjectDropDownPopup")?_clockifyProjectList.repositionDropDown():document.getElementById("divClockifyTagDropDownPopup")?_clockifyTagList.repositionDropDown():_clockifyPopupDlg.repositionDropDownCF()}function onChangedListener(t){const e=Object.keys(t);if(e.find((t=>"timeEntryInProgress"===t))){const e=t.timeEntryInProgress;this.updateButtonOnProgressChanged(e)}e.find((t=>"token"===t))&&aBrowser.storage.local.get(["token"],(t=>{t.token||this.hideClockifyButtonLinks()})),e.find((t=>"permanent_showPostStartPopup"===t))&&aBrowser.storage.local.get(["permanent_showPostStartPopup"],(t=>{_clockifyShowPostStartPopup="true"===t.permanent_showPostStartPopup})),e.find((t=>"wsSettings"===t))&&_clockifyShowPostStartPopup&&aBrowser.storage.local.get(["wsSettings"],(t=>{})),e.find((t=>"workspaceSettings"===t))&&aBrowser.storage.local.get(["workspaceSettings"],(t=>{if(t.workspaceSettings)if("STOPWATCH_ONLY"===JSON.parse(t.workspaceSettings).timeTrackingMode){const t=$("#clockify-manual-input-form"),e=$(".input-button-link");t&&(t.style.display="none"),e&&(e.style.display="none")}else{const t=$("#clockify-manual-input-form");t&&(t.style.display="inline-block");const e=$(".input-button-link");e&&(e.style.display="inline-block")}})),e.find((t=>"integrationAlert"===t))&&aBrowser.storage.local.get(["integrationAlert"],(t=>{t.integrationAlert&&(alert(t.integrationAlert),aBrowser.storage.local.set({integrationAlert:""}))}))}function cleanup(){aBrowser.storage.onChanged.removeListener(onChangedListener),aBrowser.runtime.onMessage.removeListener(onMessageListener)}function onMessageListener(t,e,o){"cleanup"===t.eventName&&cleanup(),"rerenderIntegrations"===t.eventName&&clockifyButton.rerenderAllButtons(),"passArgumentsToClockifyButton"===t.eventName&&(clockifyButton={...clockifyButton,injectedArguments:t.options})}window.clockifyListeners||(window.clockifyListeners={clockifyClicks:function(t){const e=document.getElementById("divClockifyPopupDlg");if(e)if(e.contains(t.target))_clockifyPopupDlg.onClicked(t.target),t.stopPropagation(),t.target&&("A"===t.target.tagName||t.target.id.startsWith("switchbox")||t.target.id.startsWith("txtCustomField"))||t.preventDefault();else{const e=document.getElementById("divClockifyProjectDropDownPopup");if(e&&e.contains(t.target))_clockifyPopupDlg.onClickedProjectDropDown(t.target),t.stopPropagation(),t.preventDefault();else{const e=document.getElementById("divClockifyTagDropDownPopup");if(e&&e.contains(t.target))_clockifyPopupDlg.onClickedTagDropDown(t.target),t.stopPropagation(),t.preventDefault();else{const e=document.getElementById("divClockifyLinkModal");e&&"none"!==e.style.display?(_clockifyPopupDlg.onClickedLinkModal(e,t.target),t.stopPropagation(),t.preventDefault()):_clockifyPopupDlg.onClickedCFPopup(t.target)&&(t.stopPropagation(),t.preventDefault())}}}},clockifyChanges:t=>{const e=document.getElementById("divClockifyPopupDlg");t.target&&"txtCustomFieldLinkModal"===t.target.id?($(".clockify-save").classList.remove("clockify-save--disabled"),t.stopPropagation(),t.preventDefault()):e&&e.contains(t.target)&&(_clockifyPopupDlg.onChanged(t.target),t.stopPropagation(),t.preventDefault())},clockifyRemovePopupDlg:t=>{const e=document.getElementById("divClockifyPopupDlg");if(e&&!e.contains(t.target)){const e=document.getElementById("divClockifyProjectDropDownPopup"),o=document.getElementById("divClockifyTagDropDownPopup");if(e&&e.contains(t.target)||o&&o.contains(t.target))return;clockifyDestroyPopupDlg()}},clockifyTrackResize:()=>{_clockifyPopupDlg&&clockifyRepositionDropDown()},clockifyTrackScroll:()=>{_clockifyPopupDlg&&clockifyRepositionDropDown()}}),aBrowser.storage.onChanged.addListener(onChangedListener),aBrowser.runtime.onMessage.addListener(onMessageListener);